name: Deploy to Kubernetes

on:
  push:
    branches: [main]
    tags: ['v*']
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}/reservations-api

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Deploy to ${{ github.ref_name }}
    permissions:
      contents: read
      packages: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'latest'
      
      - name: Configure kubeconfig
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.KUBE_CONFIG }}" | base64 -d > $HOME/.kube/config
          chmod 600 $HOME/.kube/config
        env:
          KUBE_CONFIG: ${{ secrets.KUBE_CONFIG }}
      
      - name: Extract image tag
        id: image
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            TAG=${GITHUB_REF#refs/tags/}
          else
            TAG=latest
          fi
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "image=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:$TAG" >> $GITHUB_OUTPUT
      
      - name: Deploy with Kustomize
        run: |
          cd k8s
          kustomize edit set image reservations-api=${{ steps.image.outputs.image }}
          kubectl apply -k .
      
      - name: Verify deployment
        run: |
          kubectl rollout status deployment/reservations-api -n reservations --timeout=5m
          kubectl get pods -n reservations
      
      - name: Run smoke tests
        run: |
          # Wait for service to be ready
          kubectl wait --for=condition=ready pod -l app=reservations-api -n reservations --timeout=300s
          
          # Port forward and test
          kubectl port-forward -n reservations svc/reservations-api 8000:8000 &
          sleep 5
          
          # Test health endpoint
          curl -f http://localhost:8000/health || exit 1
      
      - name: Comment PR on success
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'üöÄ Deployed to production successfully!'
            })
      
      - name: Slack Notification on failure (optional)
        if: failure() && secrets.SLACK_WEBHOOK != ''
        uses: slackapi/slack-github-action@v1.24.0
        with:
          slack-message: |
            ‚ùå Deployment failed!
            Repository: ${{ github.repository }}
            Branch: ${{ github.ref_name }}
            Commit: ${{ github.sha }}
          webhook-url: ${{ secrets.SLACK_WEBHOOK_URL }}
        continue-on-error: true

